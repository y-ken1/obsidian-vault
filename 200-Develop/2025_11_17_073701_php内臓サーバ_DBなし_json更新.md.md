---
aliases:
  - php
tags:
  - 
created:
  - 2025-11-17 07:37:01
---

# php内臓サーバ_DBなし_json更新


#### WSLでの構築手順

WSL2にPHPを入れる
```bash
sudo apt update
sudo apt install php-cli php-json
```

ホームディレクトリにルートフォルダ作成
```bash
mkdir ~/myphptest
cd ~/myphptest
```

php内臓サーバ起動　（~/myphptestで実行）
```bash
php -S 0.0.0.0:8000
```


phpファイル作成（data.json編集なのでdata.jsonも作成）
```bash
touch manage.php data.json
```

ブラウザでアクセス
http://localhost:8000/manage.php

data.json
```json
{
    "number": 3,
    "date": "2025-11-17",
    "text": "hoge"
}
```

manage.php:　（テスト用のため認証はなしです）
```php
<?php
// タイムゾーン
date_default_timezone_set('Asia/Tokyo');

$json_file = __DIR__ . "/data.json";
$data = json_decode(file_get_contents($json_file), true);

// data.jsonのアクセスはクロスオリジン
// http://localhost:8000/manage.php` → 管理画面
// http://localhost:8000/manage.php?api=1` → JSON取得(GETメソッドは外部ドメイン可)

if (isset($_GET['api'])) {
    header("Access-Control-Allow-Origin: *");
    echo json_encode($data);
    exit;
}

// 更新処理（POST)
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $data['number'] = intval($_POST['number']);
    $data['date']   = date("c"); // ISO 8601形式で現在日時
    $data['text']   = $_POST['text'];
    file_put_contents($json_file, json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    $msg = "JSON 更新しました";
}
?>
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>JSON管理</title>
</head>
<body>
<h1>JSON 管理画面</h1>
<?php if(isset($msg)) echo "<p style='color:green;'>$msg</p>"; ?>
<form method="post">
  <label>数字: <input type="number" name="number" value="<?= $data['number'] ?>"></label><br>
  <label>文字列: <input type="text" name="text" value="<?= htmlspecialchars($data['text']) ?>"></label><br>
  <button type="submit">更新</button>
</form>
</body>
</html>
```

外部サイト想定（fetch）
```html
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>JSON表示ページ</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2rem;
      }
      pre {
        background: #f0f0f0;
        padding: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>JSON データ表示</h1>
    <pre id="jsonDisplay">読み込み中...</pre>
    <div id="hoge" style="width: 10px;height:10px;"></pre>

    <script>
	  // サーバURL
      const url = "http://localhost:8000/manage.php?api=1";
      //   const url = "data.json"; // PHP 内蔵サーバで動作している場合

      async function fetchData() {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();

          document.getElementById("jsonDisplay").textContent = JSON.stringify(
            data,
            null,
            2
          );
          console.log(data.number)
          if (data.number > 3) {
            document.getElementById("hoge").innerHTML="<div style='width:100px;background:pink'>　　　</div>"
          } else {

            document.getElementById("hoge").innerHTML="<div style='width:100px;background:skyblue'>　　　</div>"
          }
        } catch (err) {
          document.getElementById("jsonDisplay").textContent = "エラー: " + err;
          console.error(err);
        }
      }

      // ページ読み込み時に fetch
      fetchData();

      // 一定時間おきに自動更新（例：3秒ごと）
      setInterval(fetchData, 3000);
    </script>
  </body>
</html>

```


その他 (テスト時にtailでdata.jsonが監視したときのコマンド)
```
tail -f -n 20 ~/myphptest/data.json
```


#### 認証について（今回は対象外にした）
ＤＢ使わないで簡易的にやるなら　（複雑なサイトではやらない方がいいやり方）

1. user+passの文字列をハッシュ化しておく（３組くらい？）
2. それらを環境変数に置いておく
3. 管理画面側でuser/passを入力させるフォーム作成
4. 認証は、入力値（文字列結合）と環境変数のハッシュ値の比較

```php
<?php

// TODO セッションタイムアウトの設定方法
// lolipopの場合はこのへんも参考にhttps://kamenokoki.com/article/20201004


session_start();

// --- 環境変数からハッシュを取得 ---
$valid_hashes = [
    getenv('AUTH_HASH_1'),
    getenv('AUTH_HASH_2'),
    getenv('AUTH_HASH_3'),
];

// JSONファイルを data.json に変更
$json_file = __DIR__ . '/data.json';

// --- ログイン処理 ---
if (isset($_POST['username'], $_POST['password'])) {
    $input_user = $_POST['username'];
    $input_pass = $_POST['password'];
    $combined = $input_user . $input_pass;

    $authenticated = false;
    foreach ($valid_hashes as $hash) {
        if (password_verify($combined, $hash)) {
            $authenticated = true;
            session_regenerate_id(true); // セキュリティ強化
            $_SESSION['logged_in'] = $input_user;
            break;
        }
    }

    if (!$authenticated) {
        $error = "ユーザー名またはパスワードが違います。";
    }
}

// --- ログアウト ---
if (isset($_GET['logout'])) {
    session_destroy();
    header("Location: ".$_SERVER['PHP_SELF']);
    exit;
}

// --- JSON更新処理 ---
if (!empty($_SESSION['logged_in']) && isset($_POST['flag'])) {
    $flag_data = [
        'flag' => $_POST['flag'],
        'updated_by' => $_SESSION['logged_in'],
        'updated_at' => date('c'),
    ];
    file_put_contents($json_file, json_encode($flag_data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    $msg = "更新しました！";
}

// --- JSON読み込み ---
$flag_data = file_exists($json_file) ? json_decode(file_get_contents($json_file), true) : [];

?>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>管理ページ</title>
</head>
<body>
<?php if (empty($_SESSION['logged_in'])): ?>
    <h2>ログイン</h2>
    <?php if(isset($error)) echo "<p style='color:red'>$error</p>"; ?>
    <form method="post">
        <input type="text" name="username" placeholder="ユーザー名"><br>
        <input type="password" name="password" placeholder="パスワード"><br>
        <button type="submit">ログイン</button>
    </form>
<?php else: ?>
    <p>こんにちは、<?=$_SESSION['logged_in']?>さん。 <a href="?logout">ログアウト</a></p>

    <h2>data.json 更新</h2>
    <?php if(isset($msg)) echo "<p style='color:green'>$msg</p>"; ?>
    <form method="post">
        <input type="text" name="flag" value="<?=htmlspecialchars($flag_data['flag'] ?? '')?>">
        <button type="submit">更新</button>
    </form>

    <h3>現在の JSON</h3>
    <pre><?=json_encode($flag_data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)?></pre>
<?php endif; ?>
</body>
</html>


```



